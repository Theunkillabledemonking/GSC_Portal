// JSON Web Token (JWT) λ¨λ“μ„ λ¶λ¬μµλ‹λ‹¤.
// μ‚¬μ©μμ μΈμ¦ λ° κ¶ν• κ²€μ¦μ„ μ„ν•΄ JWTλ¥Ό μ‚¬μ©ν•©λ‹λ‹¤.
const jwt = require('jsonwebtoken');

// -------------------------------------------
// 1. JWT ν† ν° κ²€μ¦ λ―Έλ“¤μ›¨μ–΄ (verifyToken)
// -------------------------------------------

// μ”μ²­ ν—¤λ”μ— ν¬ν•¨λ JWTλ¥Ό κ²€μ¦ν•©λ‹λ‹¤.
exports.verifyToken = (req, res, next) => {
    // 1. μ”μ²­ ν—¤λ”μ—μ„ 'authorization' κ°’μ„ κ°€μ Έμµλ‹λ‹¤.
    console.log('verify token', req.headers);
    const token = req.headers['authorization'];

    // 2. ν† ν°μ΄ μ—†μΌλ©΄ 403 μƒνƒ μ½”λ“μ™€ λ©”μ‹μ§€λ¥Ό λ°ν™ν•©λ‹λ‹¤.
    if (!token) return res.status(403).json({ message: 'ν† ν°μ΄ μ—†μµλ‹λ‹¤.'});

    try {
        // 3. JWT ν† ν°μ„ κ²€μ¦ν•©λ‹λ‹¤.
        // - 'Bearer [ν† ν°κ°’]' ν•μ‹μΌλ΅ μ „λ‹¬λλ―€λ΅, 'Bearer ' μ΄ν›„μ μ‹¤μ  ν† ν° κ°’μ„ μ¶”μ¶ν•©λ‹λ‹¤.
        const decoded = jwt.verify(token.split(' ')[1], process.env.JWT_SECRET);

        // 4. κ²€μ¦λ ν† ν°μ payload μ •λ³΄λ¥Ό μ”μ²­ κ°μ²΄ (req)μ— μ¶”κ°€λ©λ‹λ‹¤.
        req.user = decoded;

        // 5. λ‹¤μ λ―Έλ“¤μ›¨μ–΄λ΅ λ„μ–΄κ°‘λ‹λ‹¤.
        next();

    } catch (error) {
        // 6. ν† ν°μ΄ μ ν¨ν•μ§€ μ•μΌλ©΄ 401 μƒνƒ μ½”λ“μ™€ λ©”μ‹μ§€λ¥Ό λ°ν™ν•©λ‹λ‹¤.
        res.status(401).json({ message: 'μ ν¨ν•μ§€ μ•μ€ ν† ν°μ…λ‹λ‹¤.'});
    }
};

// -------------------------------------------
// 2. κ¶ν• ν™•μΈ λ―Έλ“¤μ›¨μ–΄ (hasRole)
// -------------------------------------------

// μ‚¬μ©μμ κ¶ν•(role)μ— μ£Όμ–΄μ§„ μ—­ν• (role) μ΄μƒμΈμ§€ ν™•μΈν•©λ‹λ‹¤.
// - κ΄€λ¦¬μ(1), κµμ(2), ν•™μƒ(3) μμΌλ΅ λ‚®μ€ μ«μκ°€ λ” λ†’μ€ κ¶ν•μ„ μλ―Έν•©λ‹λ‹¤.
exports.hasRole = (role) => {
    return (req, res, next) => {
        console.log(`π” [hasRole] μ”μ²­ν• μ‚¬μ©μ role: ${req.user?.role}, ν•„μ”ν• role: ${role}`);
        // 1. μ”μ²­λ μ‚¬μ©μμ κ¶ν•μ΄ νλΌλ―Έν„°λ΅ λ°›μ€ κ¶ν•λ³΄λ‹¤ μ‘κ±°λ‚ κ°™μΌλ©΄ μ ‘κ·Ό ν—μ©
        if (req.user.role <= role) {
            next(); // λ‹¤μ λ―Έλ“¤μ›¨μ–΄ λλ” λΌμ°νΈ ν•Έλ“¤λ¬λ΅ λ„μ–΄κ°
        } else {
            // 2. κ¶ν•μ΄ λ¶€μ΅±ν•λ©΄ 403 μƒνƒ μ½”λ“μ™€ λ©”μ‹μ§€λ¥Ό λ°ν™
            res.status(403).json({ message: 'μ ‘κ·Ό κ¶ν•μ΄ μ—†μµλ‹λ‹¤.' });
        }
    };
};

// -------------------------------------------
// 3. μΉμΈ μƒνƒ ν™•μΈ λ―Έλ“¤μ›¨μ–΄ (checkStatus)
// -------------------------------------------

// μ‚¬μ©μμ μΉμΈ μƒνƒ(status)λ¥Ό ν™•μΈν•©λ‹λ‹¤.
// - 1: μΉμΈ μ™„λ£, 0: μΉμΈ λ€κΈ°, 2: μΉμΈ κ±°λ¶€
exports.checkStatus = (req, res, next) => {
    if (req.path === "/auth/me") {
        return next();
    }

    if (req.user.status === 1) {
        // 1. μ‚¬μ©μκ°€ μΉμΈ μ™„λ£ μƒνƒμ΄λ©΄ λ‹¤μ λ―Έλ“¤μ›¨μ–΄λ΅ λ„μ–΄κ°
        next();
    } else if (req.user.status === 0) {
        // 2. μ‚¬μ©μκ°€ μΉμΈ λ€κΈ° μƒνƒμ΄λ©΄ 200 μƒνƒ μ½”λ“μ™€ λ©”μ‹μ§€λ¥Ό λ°ν™
        res.status(200).json({ status: 0 });
    } else {
        // 3. μ‚¬μ©μκ°€ μΉμΈ κ±°λ¶€ μƒνƒμ΄λ©΄ 403 μƒνƒ μ½”λ“μ™€ λ©”μ‹μ§€λ¥Ό λ°ν™
        res.status(403).json({ message: 'μΉμΈ κ±°λ¶€λμ—μµλ‹λ‹¤.' });
    }
};